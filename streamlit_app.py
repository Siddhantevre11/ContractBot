import streamlit as st
from langchain_core.messages import AIMessage, HumanMessage
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_community.chat_models import ChatOpenAI
from dotenv import load_dotenv
import os
import torch
from table_data import get_table_data  # Import the function
from faiss_helpers import initialize_vector_db, retrieve_relevant_chunks, add_pdf_to_vector_db

torch.classes.__path__ = []  # Add this line to manually set it to empty.

os.environ["TOKENIZERS_PARALLELISM"] = "false"
load_dotenv()

# Streamlit app setup
st.set_page_config(page_title="CBA Copilot", page_icon="ðŸ¤–")
st.title("CBA Copilot")

# Initialize FAISS vector database
index, metadata_store, model = initialize_vector_db()

# Initialize session state
if "chat_history" not in st.session_state:
    st.session_state.chat_history = [
        AIMessage(content="Hi, I'm your assistant. How can I help you?")]

# Upload PDF files and add to FAISS index
st.sidebar.header("Upload Documents")
uploaded_file = st.sidebar.file_uploader("Upload a PDF file", type=["pdf"])
if uploaded_file is not None:
    # Save the uploaded file temporarily
    temp_file_path = f"{uploaded_file.name}"
    with open(temp_file_path, "wb") as f:
        f.write(uploaded_file.getbuffer())
    
    # Add the PDF to the FAISS index
    try:
        index, metadata_store = add_pdf_to_vector_db(temp_file_path, index, metadata_store, model)
        st.sidebar.success(f"'{uploaded_file.name}' has been added to the FAISS index.")
    except Exception as e:
        st.sidebar.error(f"Error processing file: {e}")
    finally:
        # Clean up the temporary file
        os.remove(temp_file_path)
        

# Function to get response using Pinecone and LLM
def get_response(user_query):
    # Retrieve relevant chunks from FAISS
    top_k_results = retrieve_relevant_chunks(user_query, index, metadata_store, model, top_k=5)
    table_data= get_table_data()

    context = [result["chunk"] for result in top_k_results]
    st.session_state.context_log = top_k_results  # Store the retrieved results for reference display
    # Define LLM and prompt
    llm = ChatOpenAI(model="gpt-4o", temperature=0)
    template = """
        Use the following context to answer the user's question.
        Chat history: {chat_history}
        Context: {context}
        User question: {user_question}
        Pay Rates if asked with the 1-12 columns being years of service:

Captain Pay Rates January 2024 Bid Period (Page 37)
Aircraft               1       2       3       4       5       6       7       8       9      10     11     12
---------------------------------------------------------------------------------------------------------------
A380              577.12  581.77  586.54  591.27  596.03  600.71  605.46  610.12  614.86  619.48  624.23  628.98
A350              410.37  413.70  417.09  420.44  423.82  427.14  430.51  433.83  437.19  440.53  443.87  447.24
A330              410.37  413.70  417.09  420.44  423.82  427.14  430.51  433.83  437.19  440.53  443.87  447.24
777               410.37  413.70  417.09  420.44  423.82  427.14  430.51  433.83  437.19  440.53  443.87  447.24
787               410.37  413.70  417.09  420.44  423.82  427.14  430.51  433.83  437.19  440.53  443.87  447.24
767-400           410.37  413.70  417.09  420.44  423.82  427.14  430.51  433.83  437.19  440.53  443.87  447.24
767-200/300       340.36  343.25  346.03  348.84  351.81  354.55  357.17  360.13  362.69  366.59  370.54  374.36
757-300           340.36  343.25  346.03  348.84  351.81  354.55  357.17  360.13  362.69  366.59  370.54  374.36
757-200           340.36  343.25  346.03  348.84  351.81  354.55  357.17  360.13  362.69  366.59  370.54  374.36
A321neo/XLR       340.36  343.25  346.03  348.84  351.81  354.55  357.17  360.13  362.69  366.59  370.54  374.36
A321              331.01  333.61  336.23  338.95  341.71  344.44  347.16  349.87  352.65  355.28  358.06  360.85
737-Max10         331.01  333.61  336.23  338.95  341.71  344.44  347.16  349.87  352.65  355.28  358.06  360.85
737-Max9          331.01  333.61  336.23  338.95  341.71  344.44  347.16  349.87  352.65  355.28  358.06  360.85
737-900           331.01  333.61  336.23  338.95  341.71  344.44  347.16  349.87  352.65  355.28  358.06  360.85
737-Max8          329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
737-800           329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
A320/A320neo      329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
A319/A319neo      329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
737-500/700       329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
737-Max7          329.57  332.14  334.75  337.47  340.19  342.87  345.53  348.24  350.95  353.61  356.33  358.97
A220-300          317.60  320.23  322.81  325.42  328.05  330.70  333.30  335.90  338.50  341.12  343.77  346.39
A220-100          304.60  307.13  309.59  312.11  314.62  317.16  319.64  322.12  324.63  327.15  329.69  332.21
EMB195/E190       248.98  250.83  252.88  254.98  256.92  259.01  260.99  263.03  265.08  267.13  269.22  271.20
CRJ900            211.83  213.40  215.19  216.92  218.56  220.31  222.05  223.79  225.52  227.28  229.03  230.73

First Officer Pay Rates January 2024 Bid Period (Page 37)
Aircraft               1       2       3       4       5       6       7       8       9      10     11     12
---------------------------------------------------------------------------------------------------------------
A380              116.05  311.27  364.27  373.13  382.04  391.66  402.62  411.83  416.28  421.93  425.73  429.59
A350              116.05  221.35  259.02  265.29  271.63  278.51  286.26  292.82  296.02  300.04  302.72  305.50
A330              116.05  221.35  259.02  265.29  271.63  278.51  286.26  292.82  296.02  300.04  302.72  305.50
777               116.05  221.35  259.02  265.29  271.63  278.51  286.26  292.82  296.02  300.04  302.72  305.50
787               116.05  221.35  259.02  265.29  271.63  278.51  286.26  292.82  296.02  300.04  302.72  305.50
767-400           116.05  221.35  259.02  265.29  271.63  278.51  286.26  292.82  296.02  300.04  302.72  305.50
767-200/300       116.05  183.63  214.89  220.13  225.52  231.16  237.53  243.10  245.56  249.64  252.71  255.69
757-300           116.05  183.63  214.89  220.13  225.52  231.16  237.53  243.10  245.56  249.64  252.71  255.69
757-200           116.05  183.63  214.89  220.13  225.52  231.16  237.53  243.10  245.56  249.64  252.71  255.69
A321neo/XLR       116.05  183.63  214.89  220.13  225.52  231.16  237.53  243.10  245.56  249.64  252.71  255.69
A321              116.05  178.45  208.82  213.87  219.01  224.58  230.87  236.20  238.73  241.98  244.20  246.47
737-Max10         116.05  178.45  208.82  213.87  219.01  224.58  230.87  236.20  238.73  241.98  244.20  246.47
737-Max9          116.05  178.45  208.82  213.87  219.01  224.58  230.87  236.20  238.73  241.98  244.20  246.47
737-900           116.05  178.45  208.82  213.87  219.01  224.58  230.87  236.20  238.73  241.98  244.20  246.47
737-Max8          116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
737-800           116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
A320/A320neo      116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
A319/A319neo      116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
737-500/700       116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
737-Max7          116.05  177.71  207.89  212.95  218.07  223.52  229.76  235.07  237.58  240.79  243.00  245.19
A220-300          116.05  171.33  200.48  205.34  210.29  215.59  221.63  226.73  229.19  232.33  234.45  236.59
A220-100          116.05  164.31  192.27  196.91  201.66  206.77  212.55  217.45  219.79  222.80  224.85  226.89
EMB195/E190       116.05  134.20  157.05  160.87  164.71  168.87  173.55  177.56  179.47  181.92  183.61  185.25
CRJ900            116.05  116.05  133.60  136.85  140.10  143.65  147.65  151.06  152.67  154.75  156.21  157.57


Captain Pay Rates January 2025 Bid Period (Page 38)

Aircraft               1       2       3       4       5       6       7       8       9      10     11     12
---------------------------------------------------------------------------------------------------------------
A380                600.20  605.04  610.00  614.92  619.87  624.74  629.68  634.52  639.45  644.26  649.20  654.14
A350                426.79  430.24  433.76  437.26  440.77  444.23  447.73  451.18  454.68  458.15  461.62  465.13
A330                426.79  430.24  433.76  437.26  440.77  444.23  447.73  451.18  454.68  458.15  461.62  465.13
777                 426.79  430.24  433.76  437.26  440.77  444.23  447.73  451.18  454.68  458.15  461.62  465.13
787                 426.79  430.24  433.76  437.26  440.77  444.23  447.73  451.18  454.68  458.15  461.62  465.13
767-400             426.79  430.24  433.76  437.26  440.77  444.23  447.73  451.18  454.68  458.15  461.62  465.13
767-200/300         353.98  356.98  359.88  362.79  365.88  368.73  371.47  374.54  377.20  381.25  385.36  389.34
757-300             353.98  356.98  359.88  362.79  365.88  368.73  371.47  374.54  377.20  381.25  385.36  389.34
757-200             353.98  356.98  359.88  362.79  365.88  368.73  371.47  374.54  377.20  381.25  385.36  389.34
A321neo/A321XLR     353.98  356.98  359.88  362.79  365.88  368.73  371.47  374.54  377.20  381.25  385.36  389.34
A321                344.25  346.95  349.68  352.51  355.38  358.22  361.04  363.87  366.76  369.49  372.38  375.28
737-Max10           344.25  346.95  349.68  352.51  355.38  358.22  361.04  363.87  366.76  369.49  372.38  375.28
737-Max9            344.25  346.95  349.68  352.51  355.38  358.22  361.04  363.87  366.76  369.49  372.38  375.28
737-900             344.25  346.95  349.68  352.51  355.38  358.22  361.04  363.87  366.76  369.49  372.38  375.28
737-Max8            342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
737-800             342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
A320/A320neo        342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
A319/A319neo        342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
737-500/700         342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
737-Max7            342.75  345.42  348.15  350.96  353.80  356.58  359.36  362.16  364.99  367.76  370.58  373.33
A220-300            330.30  333.04  335.72  338.43  341.17  343.93  346.64  349.34  352.03  354.77  357.52  360.24
A220-100            316.78  319.41  321.97  324.59  327.21  329.86  332.43  335.04  337.62  340.24  342.88  345.50
EMB195/E190         258.94  260.86  263.00  265.18  267.19  269.37  271.42  273.55  275.68  277.81  279.99  282.04
CRJ900              220.30  221.94  223.80  225.60  227.30  229.13  230.93  232.75  234.54  236.37  238.19  239.96

First Officer Pay Rates January 2025 Bid Period (Page 38)
Aircraft               1        2        3        4        5        6        7        8        9       10      11      12
--------------------------------------------------------------------------------------------------------------------------
A380               120.69   323.72   378.84   388.06   397.32   407.33   418.72   428.30   432.93   438.81   442.76   446.77
A350               120.69   230.20   269.38   275.90   282.49   289.65   297.70   304.54   307.86   312.03   314.83   317.73
A330               120.69   230.20   269.38   275.90   282.49   289.65   297.70   304.54   307.86   312.03   314.83   317.73
777                120.69   230.20   269.38   275.90   282.49   289.65   297.70   304.54   307.86   312.03   314.83   317.73
787                120.69   230.20   269.38   275.90   282.49   289.65   297.70   304.54   307.86   312.03   314.83   317.73
767-400            120.69   230.20   269.38   275.90   282.49   289.65   297.70   304.54   307.86   312.03   314.83   317.73
767-200/300        120.69   190.98   223.49   228.93   234.54   240.40   247.03   252.83   255.39   259.63   262.82   265.92
757-300            120.69   190.98   223.49   228.93   234.54   240.40   247.03   252.83   255.39   259.63   262.82   265.92
757-200            120.69   190.98   223.49   228.93   234.54   240.40   247.03   252.83   255.39   259.63   262.82   265.92
A321neo/A321XLR    120.69   190.98   223.49   228.93   234.54   240.40   247.03   252.83   255.39   259.63   262.82   265.92
A321               120.69   185.59   217.17   222.43   227.77   233.57   240.11   245.64   248.28   251.66   253.97   256.33
737-Max10          120.69   185.59   217.17   222.43   227.77   233.57   240.11   245.64   248.28   251.66   253.97   256.33
737-Max9           120.69   185.59   217.17   222.43   227.77   233.57   240.11   245.64   248.28   251.66   253.97   256.33
737-900            120.69   185.59   217.17   222.43   227.77   233.57   240.11   245.64   248.28   251.66   253.97   256.33
737-Max8           120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
737-800            120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
A320/A320neo       120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
A319/A319neo       120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
737-500/700        120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
737-Max7           120.69   184.82   216.20   221.47   226.79   232.45   238.95   244.47   247.08   250.42   252.72   254.99
A220-300           120.69   178.18   208.50   213.55   218.70   224.21   230.50   235.80   238.36   241.63   243.83   246.05
A220-100           120.69   170.88   199.96   204.79   209.73   215.04   221.05   226.15   228.59   231.72   233.85   235.97
EMB195/E190        120.69   139.56   163.33   167.31   171.30   175.62   180.50   184.66   186.65   189.19   190.96   192.66
CRJ900             120.69   120.69   138.95   142.33   145.70   149.40   153.56   157.10   158.78   160.94   162.46   163.87

Captain Pay Rates January 2026 Bid Period (Page 39)
Aircraft               1       2       3       4       5       6       7       8       9      10     11     12
---------------------------------------------------------------------------------------------------------------
A380               624.21  629.24  634.40  639.52  644.66  649.73  654.87  659.90  665.03  670.03  675.17  680.31
A350               443.85  447.45  451.12  454.76  458.40  462.00  465.64  469.22  472.87  476.47  480.09  483.74
A330               443.85  447.45  451.12  454.76  458.40  462.00  465.64  469.22  472.87  476.47  480.09  483.74
777                443.85  447.45  451.12  454.76  458.40  462.00  465.64  469.22  472.87  476.47  480.09  483.74
787                443.85  447.45  451.12  454.76  458.40  462.00  465.64  469.22  472.87  476.47  480.09  483.74
767-400            443.85  447.45  451.12  454.76  458.40  462.00  465.64  469.22  472.87  476.47  480.09  483.74
767-200/300        368.14  371.26  374.27  377.31  380.51  383.48  386.33  389.52  392.29  396.50  400.77  404.92
757-300            368.14  371.26  374.27  377.31  380.51  383.48  386.33  389.52  392.29  396.50  400.77  404.92
757-200            368.14  371.26  374.27  377.31  380.51  383.48  386.33  389.52  392.29  396.50  400.77  404.92
A321neo/A321XLR    368.14  371.26  374.27  377.31  380.51  383.48  386.33  389.52  392.29  396.50  400.77  404.92
A321               358.02  360.83  363.66  366.61  369.59  372.56  375.48  378.42  381.43  384.27  387.28  390.30
737-Max10          358.02  360.83  363.66  366.61  369.59  372.56  375.48  378.42  381.43  384.27  387.28  390.30
737-Max9           358.02  360.83  363.66  366.61  369.59  372.56  375.48  378.42  381.43  384.27  387.28  390.30
737-900            358.02  360.83  363.66  366.61  369.59  372.56  375.48  378.42  381.43  384.27  387.28  390.30
737-Max8           356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
737-800            356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
A320/A320neo       356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
A319/A319neo       356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
737-500/700        356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
737-Max7           356.46  359.23  362.07  365.00  367.95  370.84  373.73  376.65  379.59  382.47  385.40  388.27
A220-300           343.51  346.36  349.15  351.97  354.82  357.69  360.50  363.31  366.11  368.96  371.82  374.66
A220-100           329.45  332.18  334.84  337.58  340.30  343.05  345.72  348.44  351.12  353.85  356.59  359.33
EMB195/E190        269.29  271.30  273.51  275.79  277.88  280.14  282.28  284.50  286.70  288.92  291.19  293.32
CRJ900             229.12  230.81  232.76  234.63  236.39  238.29  240.18  242.06  243.92  245.83  247.72  249.56

First Officer Pay Rates January 2026 Bid Period (Page 39)
Aircraft               1       2       3       4       5       6       7       8       9      10     11     12
---------------------------------------------------------------------------------------------------------------
A380              125.52  336.67  393.99  403.58  413.21  423.62  435.47  445.43  450.25  456.36  460.47  464.64
A350              125.52  239.41  280.15  286.94  293.79  301.24  309.61  316.72  320.17  324.52  327.42  330.44
A330              125.52  239.41  280.15  286.94  293.79  301.24  309.61  316.72  320.17  324.52  327.42  330.44
777               125.52  239.41  280.15  286.94  293.79  301.24  309.61  316.72  320.17  324.52  327.42  330.44
787               125.52  239.41  280.15  286.94  293.79  301.24  309.61  316.72  320.17  324.52  327.42  330.44
767-400           125.52  239.41  280.15  286.94  293.79  301.24  309.61  316.72  320.17  324.52  327.42  330.44
767-200/300       125.52  198.62  232.42  238.10  243.92  250.02  256.92  262.94  265.60  270.01  273.34  276.56
757-300           125.52  198.62  232.42  238.10  243.92  250.02  256.92  262.94  265.60  270.01  273.34  276.56
757-200           125.52  198.62  232.42  238.10  243.92  250.02  256.92  262.94  265.60  270.01  273.34  276.56
A321neo/XLR       125.52  198.62  232.42  238.10  243.92  250.02  256.92  262.94  265.60  270.01  273.34  276.56
A321              125.52  193.02  225.86  231.32  236.88  242.91  249.70  255.47  258.21  261.73  264.13  266.58
737-Max10         125.52  193.02  225.86  231.32  236.88  242.91  249.70  255.47  258.21  261.73  264.13  266.58
737-Max9          125.52  193.02  225.86  231.32  236.88  242.91  249.70  255.47  258.21  261.73  264.13  266.58
737-900           125.52  193.02  225.86  231.32  236.88  242.91  249.70  255.47  258.21  261.73  264.13  266.58
737-Max8          125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
737-800           125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
A320/A320neo      125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
A319/A319neo      125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
737-500/700       125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
737-Max7          125.52  192.22  224.85  230.32  235.86  241.75  248.51  254.25  256.97  260.44  262.83  265.19
A220-300          125.52  185.31  216.85  222.00  227.46  233.18  239.72  245.24  247.90  251.29  253.58  255.90
A220-100          125.52  177.71  207.96  212.98  218.11  223.64  229.89  235.05  237.73  240.99  243.21  245.41
EMB195/E190       125.52  145.14  169.86  174.00  178.15  182.65  187.72  192.05  194.12  196.76  198.60  200.36
CRJ900            125.52  125.52  144.51  148.02  151.53  155.37  159.70  163.38  165.14  167.38  168.96  170.43

        {table_data}
        
        Provide a concise and helpful response with one direct answer. Even if the chunks in context have answers in unnatural text blocks, only ouput ansswers in understandale english.
        Do not use mathematical foramtting. For example, instead of writing "[Average Pay Rate = (221.47 + 222.43) / 2 = 221.95]", write "The average pay rate is calculated by adding 221.47 and 222.43, then dividing by 2, which gives 221.95."
        Show calculations if needed.
        Final answer should be bolded.
        If the question is about pay rates, provide the pay rates rows you used.
        If the question is about pay rates, and no year is mentioned, provide the pay rates for the current year 2025.
        Also whatever context you used, provide page number of that and document name.
        Do not mention Docusign envelope IDs.
    """
    prompt = ChatPromptTemplate.from_template(template)
    chain = prompt | llm | StrOutputParser()

    # Generate response
    response = chain.stream({
        "context": context,
        "user_question": user_query,
        "chat_history": st.session_state.chat_history,
        "table_data": table_data
    })
    return response
if "context_log" not in st.session_state:
    st.session_state.context_log = ["Retrieved context will be displayed here"]

for message in st.session_state.chat_history:
    if isinstance(message, AIMessage):
        with st.chat_message("AI"):
            st.write(message.content)
    elif isinstance(message, HumanMessage):
        with st.chat_message("Human"):
            st.write(message.content)

user_query = st.chat_input("Type your message here...")

if user_query is not None and user_query != "":
    st.session_state.chat_history.append(HumanMessage(content=user_query))
    
    with st.chat_message("Human"):
        st.markdown(user_query)
    
    with st.chat_message("AI"):
        response = st.write_stream(get_response(user_query))
        
		 # Display references from FAISS metadata
        if st.session_state.context_log:
            st.markdown("###### **References used:**")
            for i, doc in enumerate(st.session_state.context_log, start=1):
                file_name = doc["file_name"]
                page_number = doc["page_number"]
                chunk_preview = doc["chunk"][:3000]  # Show the first 300 characters of the chunk
                with st.expander(f"{i}. {file_name} (Page {page_number})"):
                    st.text(f"Text:\n{chunk_preview}\n")

    st.session_state.chat_history.append(AIMessage(content=response))